{% extends "base.html" %}

{% block title %}Désignation de la Commande{% endblock %}

{% block content %}
<h1 class="text-center my-4">Désignation de la Commande</h1>
<div class="card">
    <div class="card-body">
        <form method="post" id="details-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="designations">Désignations:</label>
                <div id="designations-container">
                    <!-- Designation entries will be dynamically added here -->
                </div>
                <button type="button" id="add-designation" class="btn btn-secondary mt-3">Ajouter une désignation</button>
            </div>
            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary">Enregistrer</button>
                <a href="{% url 'liste_commandes' %}" class="btn btn-secondary">Annuler</a>
            </div>
        </form>
    </div>
</div>

<script>
let designationCounter = 0;

document.getElementById('add-designation').addEventListener('click', function() {
    var designationEntry = document.createElement('div');
    designationEntry.className = 'designation-entry mb-3';
    designationEntry.innerHTML = `
        <div class="input-group">
            <select class="form-control designation-select" name="designations[]" data-designation-id="${designationCounter}" required>
                <option value="">Sélectionnez une désignation</option>
                <option value="IMPRESSION OFFSET">IMPRESSION OFFSET</option>
                <option value="IMPRESSION GRAND FORMAT">IMPRESSION GRAND FORMAT</option>
                <option value="IMPRESSION PETIT FORMAT (NUMÉRIQUE)">IMPRESSION PETIT FORMAT (NUMÉRIQUE)</option>
                <option value="IMPRESSION UV">IMPRESSION UV</option>
                <option value="DÉCOUPE LASER PETIT ET GRAND FORMAT">DÉCOUPE LASER PETIT ET GRAND FORMAT</option>
                <option value="DÉCOUPE CNC GRAND FORMAT">DÉCOUPE CNC GRAND FORMAT</option>
                <option value="DÉCOUPE ADHÉSIF">DÉCOUPE ADHÉSIF</option>
                <option value="IMPRESSION TOMPOGRAPHIE DEUX COULEURS">IMPRESSION TOMPOGRAPHIE DEUX COULEURS</option>
            </select>
            <div class="input-group-append">
                <button class="btn btn-danger remove-designation" type="button">Supprimer</button>
            </div>
        </div>
        <div class="categories-container mt-2"></div>
    `;
    document.getElementById('designations-container').appendChild(designationEntry);
    designationCounter++;
});

document.addEventListener('click', function(event) {
    if (event.target.classList.contains('remove-designation')) {
        event.target.closest('.designation-entry').remove();
    }
});

document.addEventListener('change', function(event) {
    if (event.target.classList.contains('designation-select')) {
        var designationId = event.target.getAttribute('data-designation-id');
        var designation = event.target.value;
        var categoriesContainer = event.target.closest('.designation-entry').querySelector('.categories-container');
        categoriesContainer.innerHTML = '';

        if (designation) {
            categoriesContainer.innerHTML = generateCategoriesHTML(designation, designationId);
        }
    }
});

function generateCategoriesHTML(designation, designationId) {
    let categories = [];
    if (designation === 'IMPRESSION OFFSET') {
        categories = ['Impression sur Papier', 'Impression sur Enveloppe', 'Impression sur Calque', 'Impression sur Autocollant'];
    } else if (designation === 'IMPRESSION GRAND FORMAT') {
        categories = ['Impression sur Bâche', 'Impression sur Vinyle', 'Impression sur Papier', 'Impression sur One Way', 'Impression sur Canvas'];
    } else if (designation === 'IMPRESSION PETIT FORMAT (NUMÉRIQUE)') {
        categories = ['Impression sur Papier', 'Impression sur Enveloppe', 'Impression sur Calque', 'Impression sur Autocollant'];
    } else if (designation === 'IMPRESSION UV') {
        categories = ['Impression sur du Bois', 'Impression sur Métal', 'Impression sur Plastique', 'Impression sur Verre'];
    } else if (designation === 'DÉCOUPE LASER PETIT ET GRAND FORMAT') {
        categories = ['Découpe et gravure sur Bois', 'Découpe et gravure sur Métal', 'Découpe et gravure sur Plastique', 'Gravure sur Verre'];
    } else if (designation === 'DÉCOUPE CNC GRAND FORMAT') {
        categories = ['Découpe et gravure sur Bois', 'Découpe et gravure sur Plastique', 'Découpe et gravure sur Alucobond'];
    } else if (designation === 'DÉCOUPE ADHÉSIF') {
        categories = ['Découpe sur autocollant Brillant', 'Découpe sur autocollant Mat', 'Découpe sur Flex', 'Découpe sur Adhésif'];
    } else if (designation === 'IMPRESSION TOMPOGRAPHIE DEUX COULEURS') {
        categories = ['Impression sur du Bois', 'Impression sur Métal', 'Impression sur Plastique', 'Impression sur Verre'];
    }

    return categories.map((category, index) => generateCategoryHTML(category, index, designationId)).join('');
}

function generateCategoryHTML(category, index, designationId) {
    return `<div class="card mb-3">
                <div class="card-header">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input option-checkbox" id="option${designationId}_${index}" name="options[${designationId}][]" value="${category}">
                        <label class="custom-control-label" for="option${designationId}_${index}">${category}</label>
                    </div>
                </div>
                <div class="card-body details d-none">
                    <div class="form-group">
                        <label for="format${designationId}_${index}">Format:</label>
                        <input type="text" id="format${designationId}_${index}" name="formats[${designationId}][]" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="quantity${designationId}_${index}">Quantité:</label>
                        <input type="number" id="quantity${designationId}_${index}" name="quantities[${designationId}][]" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="paper_type${designationId}_${index}">Type de Papier:</label>
                        <input type="text" id="paper_type${designationId}_${index}" name="paper_types[${designationId}][]" class="form-control">
                    </div>
                </div>
            </div>`;
}

document.addEventListener('change', function(event) {
    if (event.target.classList.contains('option-checkbox')) {
        var details = event.target.closest('.card').querySelector('.details');
        details.classList.toggle('d-none', !event.target.checked);
    }
});
</script>
{% endblock %}
