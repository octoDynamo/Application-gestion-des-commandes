{% extends "base.html" %}

{% block title %}Désignation de la Commande{% endblock %}

{% block content %}
<h1 class="text-center my-4">Désignation de la Commande</h1>
<div class="card">
    <div class="card-body">
        <form method="post" id="details-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="designations">Désignations:</label>
                <div id="designations-container">
                    <div class="designation-entry mb-3">
                        <div class="input-group">
                            <select class="form-control designation-select" name="designations[]" required>
                                <option value="">Sélectionnez une désignation</option>
                                <option value="IMPRESSION OFFSET">IMPRESSION OFFSET</option>
                                <option value="IMPRESSION GRAND FORMAT">IMPRESSION GRAND FORMAT</option>
                                <option value="IMPRESSION PETIT FORMAT (NUMÉRIQUE)">IMPRESSION PETIT FORMAT (NUMÉRIQUE)</option>
                                <option value="IMPRESSION UV">IMPRESSION UV</option>
                                <option value="DÉCOUPE LASER PETIT ET GRAND FORMAT">DÉCOUPE LASER PETIT ET GRAND FORMAT</option>
                                <option value="DÉCOUPE CNC GRAND FORMAT">DÉCOUPE CNC GRAND FORMAT</option>
                                <option value="DÉCOUPE ADHÉSIF">DÉCOUPE ADHÉSIF</option>
                                <option value="IMPRESSION TOMPOGRAPHIE DEUX COULEURS">IMPRESSION TOMPOGRAPHIE DEUX COULEURS</option>
                            </select>
                            <div class="input-group-append">
                                <button class="btn btn-danger remove-designation" type="button">Supprimer</button>
                            </div>
                        </div>
                        <div class="categories-container mt-2"></div>
                    </div>
                </div>
                <button type="button" id="add-designation" class="btn btn-secondary mt-3">Ajouter une désignation</button>
            </div>
            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary">Enregistrer</button>
                <a href="{% url 'liste_commandes' %}" class="btn btn-secondary">Annuler</a>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('add-designation').addEventListener('click', function() {
    var newEntry = document.querySelector('.designation-entry').cloneNode(true);
    newEntry.querySelector('.designation-select').value = '';
    newEntry.querySelector('.categories-container').innerHTML = '';
    document.getElementById('designations-container').appendChild(newEntry);
});

document.addEventListener('click', function(event) {
    if (event.target.classList.contains('remove-designation')) {
        event.target.closest('.designation-entry').remove();
    }
});

document.addEventListener('change', function(event) {
    if (event.target.classList.contains('designation-select')) {
        var designation = event.target.value;
        var categoriesContainer = event.target.closest('.designation-entry').querySelector('.categories-container');
        categoriesContainer.innerHTML = '';

        if (designation) {
            categoriesContainer.innerHTML = generateCategoriesHTML(designation);
        }
    }
});

function generateCategoriesHTML(designation) {
    let categories = [];
    if (designation === 'IMPRESSION OFFSET') {
        categories = ['Impression sur Papier', 'Impression sur Enveloppe', 'Impression sur Calque', 'Impression sur Autocollant'];
    } else if (designation === 'IMPRESSION GRAND FORMAT') {
        categories = ['Impression sur Bâche', 'Impression sur Vinyle', 'Impression sur Papier', 'Impression sur One Way', 'Impression sur Canvas'];
    } else if (designation === 'IMPRESSION PETIT FORMAT (NUMÉRIQUE)') {
        categories = ['Impression sur Papier', 'Impression sur Enveloppe', 'Impression sur Calque', 'Impression sur Autocollant'];
    } else if (designation === 'IMPRESSION UV') {
        categories = ['Impression sur du Bois', 'Impression sur Métal', 'Impression sur Plastique', 'Impression sur Verre'];
    } else if (designation === 'DÉCOUPE LASER PETIT ET GRAND FORMAT') {
        categories = ['Découpe et gravure sur Bois', 'Découpe et gravure sur Métal', 'Découpe et gravure sur Plastique', 'Gravure sur Verre'];
    } else if (designation === 'DÉCOUPE CNC GRAND FORMAT') {
        categories = ['Découpe et gravure sur Bois', 'Découpe et gravure sur Plastique', 'Découpe et gravure sur Alucobond'];
    } else if (designation === 'DÉCOUPE ADHÉSIF') {
        categories = ['Découpe sur autocollant Brillant', 'Découpe sur autocollant Mat', 'Découpe sur Flex', 'Découpe sur Adhésif'];
    } else if (designation === 'IMPRESSION TOMPOGRAPHIE DEUX COULEURS') {
        categories = ['Impression sur du Bois', 'Impression sur Métal', 'Impression sur Plastique', 'Impression sur Verre'];
    }

    return categories.map((category, index) => generateCategoryHTML(category, index)).join('');
}

function generateCategoryHTML(category, index) {
    return `<div class="card mb-3">
                <div class="card-header">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input option-checkbox" id="option${index}" name="option${index}">
                        <label class="custom-control-label" for="option${index}">${category}</label>
                    </div>
                </div>
                <div class="card-body details d-none">
                    <div class="form-group">
                        <label for="format${index}">Format:</label>
                        <input type="text" id="format${index}" name="format${index}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="quantity${index}">Quantité:</label>
                        <input type="number" id="quantity${index}" name="quantity${index}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="paper_type${index}">Type de Papier:</label>
                        <input type="text" id="paper_type${index}" name="paper_type${index}" class="form-control">
                    </div>
                </div>
            </div>`;
}

document.addEventListener('change', function(event) {
    if (event.target.classList.contains('option-checkbox')) {
        var details = event.target.closest('.card').querySelector('.details');
        if (event.target.checked) {
            details.classList.remove('d-none');
        } else {
            details.classList.add('d-none');
        }
    }
});

document.getElementById('details-form').addEventListener('submit', function(event) {
    event.preventDefault();
    var form = event.target;
    var formData = new FormData(form);

    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': form.querySelector('input[name="csrfmiddlewaretoken"]').value,
            'Accept': 'application/json',
        },
    }).then(response => response.json()).then(data => {
        if (data.redirect_url) {
            window.location.href = data.redirect_url;
        }
    });
});
</script>
{% endblock %}
